
(function($){$.fn.loader=function(opts,args){if(this.length==0){return false;}
else if(this.length>1){return this.each(function(){this.loader(opts,args);});}
if(!opts){opts={};}
var $self=this;var key='loader';var settings=this.data(key+'-settings');var data=this.data(key+'-data');if(!settings){data={tickInterval:null,r:null,defaults:{start:false,type:'dots',r1:7,r2:12,d:12,width:2,color:'#111',sectors:8},types:['dots','lines'],cx:0,cy:0,beta:0,sectors:[],opacity:[],params:{}};}
var methods={init:function(){if(!$self.attr('id')){$self.attr('id','loader-'+Math.ceil(Math.random()*10000)).addClass('fnloader');}
Raphael.getColor.reset();settings=data.defaults;methods.updateSettings(opts);if(settings.type=='dots'){settings.r1=settings.d;settings.r2=settings.d;}
methods.calc();methods.tick();if(settings.start){methods.start();}},updateSettings:function(opts){if(opts){settings=$.extend(settings,opts);$self.data(key+'-settings',settings);}},saveData:function(){$self.data('loader-data',data);},calc:function(opts){var i=0;methods.updateSettings(opts);if(data.r){data.r.clear();data.r.setSize(settings.r2*2+settings.width*2,settings.r2*2+settings.width*2);}
else{data.r=Raphael($self.attr('id'),settings.r2*2+settings.width*2,settings.r2*2+settings.width*2);}
data.cx=settings.r2+settings.width;data.cy=settings.r2+settings.width;data.sectors=[];data.opacity=[];data.beta=2*Math.PI/settings.sectors;if(settings.type=='lines'){data.params={stroke:settings.color,"stroke-width":settings.width,"stroke-linecap":"round"};}
else if(settings.type=='dots'){data.params={fill:settings.color,stroke:'none'};}
for(i=0;i<settings.sectors;i++){var alpha=data.beta*i-Math.PI/2,cos=Math.cos(alpha),sin=Math.sin(alpha);data.opacity[i]=1/settings.sectors*i;var newSector=null;if(settings.type=='lines'){newSector=data.r.path([["M",data.cx+settings.r1*cos,data.cy+settings.r1*sin],["L",data.cx+settings.r2*cos,data.cy+settings.r2*sin]]).attr(data.params);}
else if(settings.type=='dots'){newSector=data.r.circle(data.cx+settings.r2*cos,data.cy+settings.r2*sin,settings.width).attr(data.params);}
data.sectors.push(newSector);}
methods.saveData();},start:function(){if(data.tickInterval){clearInterval(data.tickInterval);}
data.tickInterval=setInterval(function(){methods.tick();},1000/settings.sectors);},pause:function(){if(data.tickInterval){clearInterval(data.tickInterval);}},hide:function(){methods.pause();$self.hide();},show:function(){methods.start();methods.tick();$self.show();},tick:function(){var i=0;data.opacity.unshift(data.opacity.pop());for(i=0;i<settings.sectors;i++){data.sectors[i].attr("opacity",data.opacity[i]);}
data.r.safari();methods.saveData();}};if(typeof(opts)=='string'){if(methods.hasOwnProperty(opts)){var r=methods[opts](args);if(!r){return $self;}
else{return r;}}}
else{methods.init();return $self;}};})(jQuery);